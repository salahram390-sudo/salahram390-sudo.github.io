<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./style.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./account.html">Ø­Ø³Ø§Ø¨ÙŠ</a>
        <button class="btn danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet">
      <div class="sheet-handle"></div>

      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
          <div class="grid3">
            <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
            <button class="btn" id="fromSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
          <div class="grid3">
            <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
            <button class="btn" id="toSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>
      </div>

      <div class="pills">
        <span class="pill" id="statusPill">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦</span>
        <span class="pill" id="ridePill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨</span>
      </div>

      <div class="actions">
        <button class="btn primary" id="createBtn" disabled>Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
        <button class="btn" id="myLocBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>

      <div id="msg" class="hint" style="margin-top:10px"></div>
      <div id="contactBox" class="hint" style="margin-top:10px"></div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("passenger");

    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      collection, addDoc, serverTimestamp,
      doc, onSnapshot, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // Map
    // =========================
    const map = L.map("map").setView([30.0444, 31.2357], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    // Ø­Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
    setTimeout(() => map.invalidateSize(), 350);

    let from=null, to=null, fromMarker=null, toMarker=null, line=null, myMarker=null;
    const statusPill = document.getElementById("statusPill");
    const ridePill = document.getElementById("ridePill");
    const msg = document.getElementById("msg");
    const contactBox = document.getElementById("contactBox");
    const createBtn = document.getElementById("createBtn");
    const fromText = document.getElementById("fromText");
    const toText = document.getElementById("toText");

    function updateUI(){
      if(!from){
        statusPill.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        createBtn.disabled = true;
      }else if(from && !to){
        statusPill.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
        createBtn.disabled = true;
      }else{
        statusPill.textContent = "Ø¬Ø§Ù‡Ø² âœ…";
        createBtn.disabled = false;
      }
    }

    function drawLine(){
      if(from && to){
        if(line) map.removeLayer(line);
        line = L.polyline([[from.lat, from.lng],[to.lat,to.lng]]).addTo(map);
        map.fitBounds(line.getBounds(), {padding:[30,30]});
      }
    }

    function setFrom(lat,lng){
      from={lat,lng};
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      map.setView([lat,lng], 14);
      drawLine(); updateUI();
    }

    function setTo(lat,lng){
      to={lat,lng};
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
      map.setView([lat,lng], 14);
      drawLine(); updateUI();
    }

    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" } });
      if(!res.ok) throw new Error("geocode failed");
      const data = await res.json();
      if(!data?.length) return null;
      return { lat:Number(data[0].lat), lng:Number(data[0].lon) };
    }

    async function search(type){
      msg.textContent = "";
      contactBox.textContent = "";
      const text = (type==="from"?fromText.value:toText.value).trim();
      if(!text) return msg.textContent="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
      try{
        const r = await geocode(text);
        if(!r) return msg.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†.";
        if(type==="from") setFrom(r.lat,r.lng); else setTo(r.lat,r.lng);
      }catch(e){
        console.error(e);
        msg.textContent="Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }
    }

    document.getElementById("fromSearchBtn").addEventListener("click",()=>search("from"));
    document.getElementById("toSearchBtn").addEventListener("click",()=>search("to"));

    function showMyLocation(opts={ saveAsFromIfEmpty:true }){
      msg.textContent = "";
      if(!navigator.geolocation) return msg.textContent="Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat=pos.coords.latitude, lng=pos.coords.longitude;

        if(myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
        map.setView([lat,lng], 16);

        // âœ… Ù„Ùˆ Ù„Ø³Ù‡ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù… Ù…Ø´ Ù…ØªØ­Ø¯Ø¯: Ù†Ø®Ù„ÙŠÙ‡ Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if(opts.saveAsFromIfEmpty && !from){
          setFrom(lat,lng);
          fromText.value = "Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ";
        }
      }, ()=>{
        msg.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø°Ù†.";
      }, {enableHighAccuracy:true, timeout:10000});
    }

    // âœ… Ø§ÙØªØ­ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    showMyLocation({ saveAsFromIfEmpty:true });

    document.getElementById("myLocBtn").addEventListener("click", ()=>showMyLocation({ saveAsFromIfEmpty:false }));

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      from=null;to=null;
      fromText.value="";toText.value="";
      [fromMarker,toMarker,line,myMarker].forEach(x=>{ if(x) map.removeLayer(x); });
      fromMarker=toMarker=line=myMarker=null;
      msg.textContent="";
      contactBox.textContent="";
      updateUI();
    });

    // =========================
    // Ride: create + watch
    // =========================
    let unsubRide = null;

    function watchRide(rideId){
      if(unsubRide) unsubRide();
      contactBox.textContent = "";
      const ref = doc(db, "rides", rideId);

      unsubRide = onSnapshot(ref, async (snap)=>{
        if(!snap.exists()) return;

        const r = snap.data();

        if(r.status === "open"){
          ridePill.textContent = "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚â€¦";
          ridePill.className = "pill";
          contactBox.textContent = "";
          return;
        }

        if(r.status === "accepted"){
          ridePill.textContent = "âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨";
          ridePill.className = "pill ok";

          const name = r.driverName || "Ø³Ø§Ø¦Ù‚";
          const phone = r.driverPhone || "";
          const driverLat = r.driverLocation?.lat ?? null;
          const driverLng = r.driverLocation?.lng ?? null;

          let html = `âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚: <b>${name}</b>`;
          if(phone) html += ` â€” <a href="tel:${phone}">${phone}</a>`;

          if(driverLat && driverLng){
            html += `<br><a id="goDriver" href="#">ğŸ“ Ø§ÙØªØ­ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>`;
          }

          contactBox.innerHTML = html;

          const go = document.getElementById("goDriver");
          if(go && driverLat && driverLng){
            go.addEventListener("click", (e)=>{
              e.preventDefault();
              map.setView([driverLat, driverLng], 16);
              L.popup().setLatLng([driverLat, driverLng]).setContent("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚").openOn(map);
            });
          }
        }
      });
    }

    const lastRideId = localStorage.getItem("lastRideId");
    if(lastRideId) watchRide(lastRideId);

    createBtn.addEventListener("click", async ()=>{
      try{
        msg.textContent="";
        contactBox.textContent="";

        if(!from || !to){
          msg.textContent = "âŒ Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„.";
          updateUI();
          return;
        }

        createBtn.disabled = true;
        msg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const u = await getUserDoc(user.uid);
        const passengerName = u?.name || null;
        const passengerPhone = u?.phone || null;

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),

          from, to,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null,

          passengerUid: user.uid,
          passengerEmail: user.email,
          passengerName,
          passengerPhone,

          // Ù‡Ù†Ø¶ÙŠÙÙ‡Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚:
          driverUid: null,
          driverName: null,
          driverPhone: null,
          driverLocation: null
        });

        localStorage.setItem("lastRideId", docRef.id);
        watchRide(docRef.id);

        msg.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù…: ${docRef.id}`;
      }catch(e){
        console.error(e);
        msg.textContent="âŒ Ø­ØµÙ„ Ø®Ø·Ø£. Ø±Ø§Ø¬Ø¹ Firestore Rules.";
      }finally{
        updateUI();
      }
    });

    updateUI();
  </script>
</body>
</html>
