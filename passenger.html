<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./style.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <meta name="theme-color" content="#070A10" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"></div>

      <div class="sheet-content" id="sheetContent">
        <div class="grid2">
          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
            <div class="grid3">
              <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
              <button class="btn" id="fromSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>

          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
            <div class="grid3">
              <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
              <button class="btn" id="toSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>
        </div>

        <div class="pills">
          <span class="pill" id="statusPill">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦</span>
          <span class="pill" id="ridePill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨</span>
          <span class="pill" id="permPill">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
        </div>

        <div id="contactBox" class="card" style="margin-top:12px; display:none"></div>

        <div class="actions">
          <button class="btn primary" id="createBtn" disabled>Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
          <button class="btn" id="myLocBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          <button class="btn" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>

        <div id="msg" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("passenger");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      collection, addDoc, serverTimestamp,
      doc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… Leaflet marker icons fix
    L.Icon.Default.mergeOptions({
      iconRetinaUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",
      iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    });

    // âœ… Map
    const map = L.map("map", { zoomControl:false }).setView([30.0444, 31.2357], 12);

    // âœ… Tiles (Fix: Ù„Ùˆ CARTO ÙˆÙ‚Ø¹/Ø§ØªØ­Ø¬Ø¨ØŒ Ù†Ø­ÙˆÙ„ Ù„Ù€ OSM ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    const carto = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      subdomains: "abcd",
      crossOrigin: true
    });

    const osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap',
      crossOrigin: true
    });

    // Ø§Ø¨Ø¯Ø£ Ø¨Ù€ CARTO
    carto.addTo(map);

    // Ù„Ùˆ Ø§Ù„ØªØ§ÙŠÙ„Ø² ÙØ´Ù„Øª => Switch Ù„Ù€ OSM
    let switched = false;
    carto.on("tileerror", () => {
      if (switched) return;
      switched = true;
      try { map.removeLayer(carto); } catch(e){}
      osm.addTo(map);
    });

    // âœ… invalidate size Ù…Ø¶Ø¨ÙˆØ·
    const forceResize = () => { try { map.invalidateSize(); } catch(e){} };
    setTimeout(forceResize, 300);
    window.addEventListener("resize", () => setTimeout(forceResize, 200));

    let from=null, to=null, fromMarker=null, toMarker=null, line=null, myMarker=null, accuracyCircle=null;

    const statusPill = document.getElementById("statusPill");
    const ridePill   = document.getElementById("ridePill");
    const permPill   = document.getElementById("permPill");
    const msg        = document.getElementById("msg");
    const createBtn  = document.getElementById("createBtn");

    const fromText = document.getElementById("fromText");
    const toText   = document.getElementById("toText");
    const contactBox = document.getElementById("contactBox");

    function setPermPill(state){
      permPill.classList.remove("ok","bad");
      if(state === "granted"){
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø³Ù…ÙˆØ­ âœ…";
        permPill.classList.add("ok");
      }else if(state === "denied"){
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶ âŒ";
        permPill.classList.add("bad");
      }else{
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      }
    }

    async function refreshPermissionState(){
      try{
        if(!navigator.permissions?.query) return setPermPill("unknown");
        const p = await navigator.permissions.query({ name: "geolocation" });
        setPermPill(p.state);
        p.onchange = () => setPermPill(p.state);
      }catch{
        setPermPill("unknown");
      }
    }
    refreshPermissionState();

    function updateUI(){
      if(!from){
        statusPill.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        createBtn.disabled = true;
      } else if(from && !to){
        statusPill.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
        createBtn.disabled = true;
      } else {
        statusPill.textContent = "Ø¬Ø§Ù‡Ø² âœ…";
        createBtn.disabled = false;
      }
    }

    function drawLine(){
      if(from && to){
        if(line) map.removeLayer(line);
        line = L.polyline([[from.lat, from.lng],[to.lat,to.lng]]).addTo(map);
        map.fitBounds(line.getBounds(), { padding:[30,30] });
      }
    }

    function setFrom(lat,lng){
      from={lat,lng};
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      map.setView([lat,lng], 14);
      drawLine(); updateUI();
    }
    function setTo(lat,lng){
      to={lat,lng};
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
      map.setView([lat,lng], 14);
      drawLine(); updateUI();
    }

    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" } });
      if(!res.ok) throw new Error("geocode failed");
      const data = await res.json();
      if(!data?.length) return null;
      return { lat:Number(data[0].lat), lng:Number(data[0].lon) };
    }

    async function search(type){
      msg.textContent = "";
      const text = (type==="from"?fromText.value:toText.value).trim();
      if(!text) return msg.textContent="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
      try{
        const r = await geocode(text);
        if(!r) return msg.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†.";
        if(type==="from") setFrom(r.lat,r.lng); else setTo(r.lat,r.lng);
      }catch(e){
        console.error(e);
        msg.textContent="Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }
    }

    document.getElementById("fromSearchBtn").addEventListener("click",()=>search("from"));
    document.getElementById("toSearchBtn").addEventListener("click",()=>search("to"));

    function explainLocationDenied(){
      msg.innerHTML =
        "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.<br>" +
        "Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
    }

    // âœ… FIX Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø²Ø± Ù…ÙˆÙ‚Ø¹ÙŠ: Leaflet locate + fallback
    const myLocBtn = document.getElementById("myLocBtn");

    function clearMyLoc(){
      if(myMarker) map.removeLayer(myMarker);
      if(accuracyCircle) map.removeLayer(accuracyCircle);
      myMarker = null;
      accuracyCircle = null;
    }

    map.on("locationfound", (e) => {
      setPermPill("granted");
      msg.textContent = "";
      clearMyLoc();

      myMarker = L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();

      if (Number.isFinite(e.accuracy)) {
        accuracyCircle = L.circle(e.latlng, { radius: e.accuracy }).addTo(map);
      }

      map.setView(e.latlng, 16);
      setTimeout(forceResize, 250);
      myLocBtn.disabled = false;
    });

    map.on("locationerror", (e) => {
      console.error(e);
      myLocBtn.disabled = false;

      // Permission denied
      if (String(e.message || "").toLowerCase().includes("denied")) {
        setPermPill("denied");
        explainLocationDenied();
        return;
      }

      // Fallback to navigator.geolocation direct
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          setPermPill("granted");
          msg.textContent = "";
          clearMyLoc();

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          myMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
          if (Number.isFinite(pos.coords.accuracy)) {
            accuracyCircle = L.circle([lat,lng], { radius: pos.coords.accuracy }).addTo(map);
          }
          map.setView([lat,lng], 16);
          setTimeout(forceResize, 250);
        }, (err) => {
          console.error(err);
          if (err?.code === 1) {
            setPermPill("denied");
            explainLocationDenied();
          } else {
            msg.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
          }
        }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
      } else {
        msg.textContent = "Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      }
    });

    myLocBtn.addEventListener("click", () => {
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";
      myLocBtn.disabled = true;

      if (!navigator.geolocation) {
        myLocBtn.disabled = false;
        return msg.textContent = "Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      }

      // Leaflet locate
      map.locate({
        setView: false,
        watch: false,
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 0
      });
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      from=null;to=null;
      fromText.value="";toText.value="";
      [fromMarker,toMarker,line].forEach(x=>{ if(x) map.removeLayer(x); });
      fromMarker=toMarker=line=null;

      clearMyLoc();

      msg.textContent="";
      contactBox.style.display="none";
      contactBox.innerHTML="";
      updateUI();
      setTimeout(forceResize, 200);
    });

    function toWhatsappNumber(phone){
      if(!phone) return null;
      let p = String(phone).trim().replace(/\s+/g,"").replace(/-/g,"");
      if(p.startsWith("0")) p = "20" + p.slice(1);
      if(p.startsWith("+")) p = p.slice(1);
      p = p.replace(/[^\d]/g,"");
      return p || null;
    }

    let unsubRide = null;
    function watchRide(rideId){
      if(unsubRide) unsubRide();
      const ref = doc(db, "rides", rideId);

      unsubRide = onSnapshot(ref, (snap)=>{
        if(!snap.exists()){
          ridePill.textContent = "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          contactBox.style.display="none";
          contactBox.innerHTML="";
          return;
        }

        const r = snap.data();

        if(r.status === "open"){
          ridePill.textContent = "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚â€¦";
          contactBox.style.display="none";
          contactBox.innerHTML="";
        }

        if(r.status === "accepted"){
          const dName = r.driverName || "Ø³Ø§Ø¦Ù‚";
          const dPhone = r.driverPhone || "";
          ridePill.textContent = "âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚";

          const waNum = toWhatsappNumber(dPhone);
          const pickupLat = r.from?.lat;
          const pickupLng = r.from?.lng;
          const mapLink = (pickupLat && pickupLng)
            ? `https://www.openstreetmap.org/?mlat=${pickupLat}&mlon=${pickupLng}#map=16/${pickupLat}/${pickupLng}`
            : null;

          contactBox.style.display = "block";
          contactBox.innerHTML = `
            <div class="kv">
              <b>ğŸ‘¤ ${dName}</b>
              <span>${dPhone ? "ğŸ“ " + dPhone : "ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…"}</span>
            </div>
            <div class="row" style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              ${dPhone ? `<a class="btn success" href="tel:${dPhone}">Ø§ØªØµØ§Ù„</a>` : ``}
              ${waNum ? `<a class="btn" target="_blank" href="https://wa.me/${waNum}">ÙˆØ§ØªØ³Ø§Ø¨</a>` : ``}
              ${mapLink ? `<a class="btn" target="_blank" href="${mapLink}">ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</a>` : ``}
            </div>
          `;
        }
      });
    }

    const lastRideId = localStorage.getItem("lastRideId");
    if(lastRideId) watchRide(lastRideId);

    createBtn.addEventListener("click", async ()=>{
      try{
        createBtn.disabled = true;
        msg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const u = await getUserDoc(user.uid);
        const passengerName = u?.name || null;
        const passengerPhone = u?.phone || null;

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),
          from, to,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null,
          passengerUid: user.uid,
          passengerEmail: user.email,
          passengerName,
          passengerPhone
        });

        localStorage.setItem("lastRideId", docRef.id);
        watchRide(docRef.id);

        msg.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù…: ${docRef.id}`;
      }catch(e){
        console.error(e);
        msg.textContent="âŒ Ø­ØµÙ„ Ø®Ø·Ø£. Ø±Ø§Ø¬Ø¹ Firestore Rules.";
      }finally{
        updateUI();
      }
    });

    updateUI();

    // =========================
    // âœ… Drag Bottom Sheet (Handle ONLY)
    // =========================
    const sheet   = document.getElementById("sheet");
    const handle  = document.getElementById("sheetHandle");
    const content = document.getElementById("sheetContent");

    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

    const getPoints = () => {
      const vh = window.innerHeight;
      const collapsed = Math.max(120, Math.round(vh * 0.18));
      const mid       = Math.round(vh * 0.42);
      const expanded  = Math.round(vh * 0.78);
      return { collapsed, mid, expanded };
    };

    let points = getPoints();
    let current = points.mid;

    let startY = 0, startCurrent = 0, dragging = false;

    function render(y, animate=true){
      current = clamp(y, points.collapsed, points.expanded);
      sheet.style.transition = animate ? "transform .18s ease" : "none";
      sheet.style.transform  = `translateY(${points.expanded - current}px)`;
      content.style.maxHeight = (current >= points.mid) ? "70vh" : "55vh";
      if(animate) setTimeout(()=> sheet.style.transition="", 200);
    }

    function nearestSnap(y){
      const arr = [points.collapsed, points.mid, points.expanded];
      return arr.reduce((a,b)=> (Math.abs(b-y) < Math.abs(a-y) ? b : a), arr[0]);
    }

    function down(e){
      dragging = true;
      sheet.classList.add("dragging");
      startY = (e.touches ? e.touches[0].clientY : e.clientY);
      startCurrent = current;
    }

    function move(e){
      if(!dragging) return;
      const y = (e.touches ? e.touches[0].clientY : e.clientY);
      const dy = startY - y;
      render(startCurrent + dy, false);
      e.preventDefault();
    }

    function up(){
      if(!dragging) return;
      dragging = false;
      sheet.classList.remove("dragging");
      render(nearestSnap(current), true);
      setTimeout(forceResize, 240);
    }

    render(current, false);

    handle.addEventListener("touchstart", down, {passive:false});
    handle.addEventListener("touchmove", move, {passive:false});
    handle.addEventListener("touchend", up);

    handle.addEventListener("mousedown", down);
    window.addEventListener("mousemove", move, {passive:false});
    window.addEventListener("mouseup", up);

    window.addEventListener("resize", ()=>{
      points = getPoints();
      current = clamp(current, points.collapsed, points.expanded);
      render(current, false);
      setTimeout(forceResize, 240);
    });

  </script>
</body>
</html>
