<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشوارك - سائق</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">م</div>
        <div>
          <h1>سائق</h1>
          <p id="who">جارٍ التحميل…</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./account.html">حسابي</a>
        <button class="btn danger" id="logoutBtn">خروج</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:18px">
    <div class="card">
      <div class="hint">الطلبات المفتوحة تظهر هنا. اضغط “قبول” علشان الراكب يشوف إنك وافقت.</div>
      <div class="actions" style="margin-top:10px">
        <button class="btn" id="refreshBtn">تحديث</button>
      </div>
    </div>

    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      collection, query, where, orderBy, limit, getDocs,
      doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const listEl = document.getElementById("list");
    const refreshBtn = document.getElementById("refreshBtn");

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    async function load(){
      listEl.innerHTML = `<div class="card">جارٍ تحميل الطلبات…</div>`;

      const q = query(
        collection(db, "rides"),
        where("status","==","open"),
        orderBy("createdAt","desc"),
        limit(25)
      );

      const snap = await getDocs(q);
      listEl.innerHTML = "";

      if(snap.empty){
        listEl.innerHTML = `<div class="card">لا توجد طلبات مفتوحة الآن.</div>`;
        return;
      }

      snap.forEach(d=>{
        const r = { id:d.id, ...d.data() };

        const fromLat = safeNum(r.from?.lat);
        const fromLng = safeNum(r.from?.lng);
        const toLat = safeNum(r.to?.lat);
        const toLng = safeNum(r.to?.lng);

        const el = document.createElement("div");
        el.className = "card ride";
        el.innerHTML = `
          <div class="kv">
            <b>طلب: ${r.id}</b>
            <span>من: ${r.fromText || (fromLat&&fromLng? `${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}`:"-")}</span>
            <span>إلى: ${r.toText || (toLat&&toLng? `${toLat.toFixed(5)}, ${toLng.toFixed(5)}`:"-")}</span>
          </div>
          <div class="row">
            <button class="btn success" data-id="${r.id}">قبول</button>
            ${fromLat && fromLng ? `
              <a class="btn" target="_blank"
                 href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
                فتح الانطلاق
              </a>` : ``}
          </div>
        `;

        el.querySelector("button").addEventListener("click", async ()=>{
          try{
            const me = await getUserDoc(user.uid);
            const driverName = me?.name || "سائق";
            const driverPhone = me?.phone || null;

            await updateDoc(doc(db, "rides", r.id), {
              status: "accepted",
              acceptedAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone
            });

            await load();
          }catch(e){
            console.error(e);
            alert("فشل قبول الطلب. راجع Firestore Rules.");
          }
        });

        listEl.appendChild(el);
      });
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
